<!DOCTYPE html>
<html>
  <head>
    <title>ABI Encode/Decode</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/ruby-3_2-wasm-wasi@2.1.0/dist/browser.script.iife.js"></script>
    <script type="text/ruby" src="https://ipfs.io/ipfs/bafkreicutpljjabczkmprlja3mquomqa2ibsl6tpb7ev4vuhfj5jlom6dm"></script>
    <script type="text/ruby">
    require "js"
    require "json"

    class String
      def binary?
        self.each_char do |char|
          return true if char.ord < 32 || char.ord > 126
        end
        false
      end
    end

    module ABI
      extend AbiCoderRb

      before_encoding lambda { |type, value|
        if type.start_with?("bytes")
          hex_to_bin(value)
        elsif type.start_with?("uint") || type.start_with?("int")
          value.to_i
        elsif type == "string"
          value
        else
          value
        end
      }

      after_decoding lambda { |type, value|
        if type == "address"
          "0x#{value}"
        elsif type.start_with?("bytes")
          "0x#{bin_to_hex(value)}"
        elsif type == "string"
          value.binary? ? ABI.bin_to_hex(value) : value
        else
          value
        end
      }
    end

    document = JS.global[:document]
    btn_encode = document.getElementById "btnEncode"
    btn_encode.addEventListener "click" do
      type = document.getElementById("type")[:value].to_s.strip
      value = JSON.parse(document.getElementById("value")[:value].to_s)
      p type
      p value
      result = ABI.encode(type, value)
      document.getElementById("data")[:value] = "0x" + ABI.bin_to_hex(result)
    end

    btn_decode = document.getElementById "btnDecode"
    btn_decode.addEventListener "click" do
      type = document.getElementById("type")[:value].to_s.strip
      data = document.getElementById("data")[:value].to_s.strip
      result = ABI.decode(type, ABI.hex_to_bin(data))
      document.getElementById("value")[:value] = result.to_json
    end

    </script>

    <style type="text/css">
    * {
    box-sizing: border-box;
    }
    pre {
    white-space: pre-wrap;       /* Since CSS 2.1 */
    white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
    white-space: -pre-wrap;      /* Opera 4-6 */
    white-space: -o-pre-wrap;    /* Opera 7 */
    word-wrap: break-word;       /* Internet Explorer 5.5+ */
    }
    input, textarea {
    padding: 5px;
    }
    </style>
  </head>
  <body>
    <form style="">
      <p>
      <div>type: </div>

      <input type="text" id="type" name="type" value='(bytes32,(address,uint256,uint256,address,uint256,address,uint256,bytes))' style="width: 100%"></input>

      </textarea>
      <p>
      <div>decoded value: </div>
      <textarea id="value" name="value" value="" style="width: 100%" rows=16>
[
    "0x2628abe10aaf809f0ea9a33fb15782582e8d8353ea15698d7067b057748581a4",
    [
        "0x00000000001523057a05d6293c1e5171ee33ee0a",
        195,
        421614,
        "0x0000000000d2de3e2444926c4577b0a59f1dd8bc",
        44,
        "0x0000000000d2de3e2444926c4577b0a59f1dd8bc",
        473508,
        "0x394d1bca0000000000000000000000000b001c95e86d64c1ad6e43944c568a6c31b538870000000000000000000000000b001c95e86d64c1ad6e43944c568a6c31b53887000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000090841287191622077700000000000000000000000000000000000000000000000"
    ]
]
      </textarea>
      </p>
      <button type="button" id="btnEncode">encode▼</button>
      <button type="button" id="btnDecode">decode▲</button>
      <p>
      <div>encoded data: </div>
      <textarea id="data" name="data" value="" style="width: 100%" rows="16">
0x2628abe10aaf809f0ea9a33fb15782582e8d8353ea15698d7067b057748581a4000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000001523057a05d6293c1e5171ee33ee0a00000000000000000000000000000000000000000000000000000000000000c30000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000d2de3e2444926c4577b0a59f1dd8bc000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000d2de3e2444926c4577b0a59f1dd8bc00000000000000000000000000000000000000000000000000000000000739a4000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000a4394d1bca0000000000000000000000000b001c95e86d64c1ad6e43944c568a6c31b538870000000000000000000000000b001c95e86d64c1ad6e43944c568a6c31b5388700000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000009084128719162207770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
      </textarea>
      </p>
    </form>

    more examples: <a href="https://github.com/wuminzhe/abi_coder_rb/tree/main/spec" target="_blank">abi_coder_rb</a>
  </body>
</html>
